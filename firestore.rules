
rules_version = '2';

/**
 * @file firestore.rules
 * @description Security rules for the MechQuote Firestore database.
 *
 * ## Core Philosophy
 * This ruleset is designed for a prototyping environment with anonymous authentication.
 * It prioritizes rapid development by allowing any signed-in user (including anonymous ones)
 * to read and write data. Strict owner-based rules will be re-implemented when a full
 * authentication system is added later.
 *
 * ## Key Security Decisions
 * - **Open Access for Authenticated Users**: Any authenticated user can perform CRUD
 *   operations on any top-level collection. This simplifies development by removing
 *   permission errors during the prototyping phase.
 * - **Client-Side Data Integrity**: The application logic is currently responsible for
 *   associating data with the correct user via an `ownerId`. The rules currently
 *   do not enforce this link.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    /**
     * Returns true if the user is authenticated (can be an anonymous user).
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description
     *   Rules for the `suppliers` collection.
     *   Allows read/write access for any signed-in user.
     * @path
     *   /suppliers/{supplierId}
     */
    match /suppliers/{supplierId} {
      allow read, write: if isSignedIn();

      /**
       * @description
       *   Rules for materials, nested under a supplier.
       *   Allows read/write access if the user is signed in.
       * @path
       *   /suppliers/{supplierId}/materials/{materialId}
       */
      match /materials/{materialId} {
          allow read, write: if isSignedIn();
      }
    }

    /**
     * @description
     *   Rules for the `labor_costs` collection.
     *   Allows read/write access for any signed-in user.
     * @path
     *   /labor_costs/{laborCostId}
     */
    match /labor_costs/{laborCostId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description
     *   Rules for the `recipes` collection.
     *   Allows read/write access for any signed-in user.
     * @path
     *   /recipes/{recipeId}
     */
    match /recipes/{recipeId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description
     *   Rules for the `customers` collection.
     *   Allows read/write access for any signed-in user.
     * @path
     *   /customers/{customerId}
     */
    match /customers/{customerId} {
      allow read, write: if isSignedIn();
    }
    
    /**
     * @description
     *   Rules for the top-level `proposals` collection.
     *   Allows read/write access for any signed-in user.
     * @path
     *   /proposals/{proposalId}
     */
    match /proposals/{proposalId} {
      allow read, write: if isSignedIn();
      
      /**
       * @description
       *   Rules for proposal items, nested under a proposal.
       *   Allows read/write access if the user is signed in.
       * @path
       *   /proposals/{proposalId}/proposal_items/{proposalItemId}
       */
      match /proposal_items/{proposalItemId} {
          allow read, write: if isSignedIn();
      }
    }

    /**
     * @description
     *   Rules for the `products` collection.
     *   Allows read/write access for any signed-in user.
     * @path
     *   /products/{productId}
     */
    match /products/{productId} {
      allow read, write: if isSignedIn();
    }
  }
}
