
rules_version = '2';

/**
 * @file firestore.rules
 * @description Security rules for the MechQuote Firestore database.
 *
 * ## Core Philosophy
 * This ruleset is designed for a prototyping environment with anonymous authentication.
 * It prioritizes rapid development by allowing any signed-in user (including anonymous ones)
 * to read and write data they own, based on the `ownerId` field.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    /**
     * Returns true if the user is authenticated (can be an anonymous user).
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the incoming data's ownerId matches the user's UID.
     */
    function isNewOwner(resource) {
        return resource.data.ownerId == request.auth.uid;
    }

    /**
     * Returns true if the existing data's ownerId matches the user's UID.
     */
    function isOwner(resource) {
        return resource.data.ownerId == request.auth.uid;
    }
    
    /**
     * Returns true if the query is limited to the user's own documents.
     */
    function isQueryingOwnData() {
        return request.query.limit <= 100 && request.auth.uid == request.query.resource.data.ownerId;
    }


    /**
     * @description
     *   Rules for collections where documents have an `ownerId`.
     *   - Allows `list` only if querying by `ownerId`.
     *   - Allows `read`, `update`, `delete` if the user is the owner.
     *   - Allows `create` if the new document's `ownerId` is the user's UID.
     */
    match /{collection}/{docId} where collection in ['customers', 'products', 'proposals'] {
      allow list: if isSignedIn() && isQueryingOwnData();
      allow read, update, delete: if isSignedIn() && isOwner(get(/databases/$(database)/documents/$(collection)/$(docId)));
      allow create: if isSignedIn() && isNewOwner(request.resource);
    }
    
    /**
     * @description
     *   Rules for proposal items, nested under a proposal.
     *   Inherits ownership from the parent proposal.
     */
    match /proposals/{proposalId}/proposal_items/{proposalItemId} {
        allow read, write: if isSignedIn() && isOwner(get(/databases/$(database)/documents/proposals/$(proposalId)));
    }


    // The following rules remain open for prototyping simplicity as they don't have ownerId
    // or are not directly user-created content in the same way.
    match /suppliers/{supplierId} {
      allow read, write: if isSignedIn();
      match /materials/{materialId} {
          allow read, write: if isSignedIn();
      }
    }
    match /labor_costs/{laborCostId} {
      allow read, write: if isSignedIn();
    }
    match /recipes/{recipeId} {
      allow read, write: if isSignedIn();
    }
  }
}
